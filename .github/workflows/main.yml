name: iOS Build & Auto-Fix

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: '0 3 * * 1' # every Monday at 3 AM UTC

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up latest Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest

      - name: Clean derived data
        run: rm -rf ~/Library/Developer/Xcode/DerivedData/*

      - name: Resolve Swift packages
        run: xcodebuild -resolvePackageDependencies

      - name: Build XsiteUAE for iPhone 17 Pro
        run: |
          xcodebuild -scheme "Xsiteuae" \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=latest' \
            clean build

      - name: Run tests
        run: |
          xcodebuild test \
            -scheme "Xsiteuae" \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=latest'

      - name: Auto commit dependency updates
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Auto-fix: updated dependencies and rebuilt project"
          title: "Auto-fix build issues"
          body: "This pull request includes automatic fixes and dependency updates."
          branch: auto-fix/build

